### Wubba lubba dub dub

В понедельник поутру,  
В Вездекод я захожу.  
Что же там сегодня будет:  
Веб, мобайл или ~~вью~~ дизайн?  

Вот и новое задание,  
Прерываем ожидание,   
Уязвимость почините и   
Увидите good code.  

Мы немного посидели,   
Запустили приложенье.  
Вот проблема отыскалась,  
No-referrer пропускалось.  

Чтоб проблему выявлять  
И корректно код писать,    
Лучше доку почитайте:  
https://www.w3.org/TR/referrer-policy/#intro-privacy.  

Там описано красиво  
Почему такое было,  
Для соц сети очень важно,  
Чтобы было безопасно.  

Ведь не надо никому  
Знать о юзере инфу:  
Чтобы юзер был спокоен  
За его секретный токен.  

Мы вас больше не задержим  
Текст был классный, споров нет.  
Теперь внимательно прочтите  
Наш ответ:  

### Описание уязвимости
При загрузке изображения с внешних источников в заголовке запроса Referer отправляется URL исходной страницы мини-приложения, которая содержит параметры запуска и подпись для авторизации пользователя. Администратор сервера, на котором хранится изображение, может получить эти данные и авторизоваться в мини-приложении под аккаунтом другого пользователя и получить его данные.

### Почему происходит подмена
Вероятно, на сервере по адресу https://service.pavel.im/image стоит проверка заголовоков запроса. Если в заголовке “referer” найдены параметры запуска, то в ответ приходит изображение “Bad code”, если параметров нет - “Good code”

### Как мы ее исправили?
Добавили атрибут referrerpolicy к тегу img со значением no-referrer, чтобы при запросе изображения с сервера не отправлялся заголовок "referrer" с параметрами запуска. 

#### Safari on iOS issue
Мы протестировали работу атрибута на iOS разных версий. На iOS 13.5.1-13.7 атрибут referrerpolicy игнорируется, поэтому дополнительным решением по установке referer policy стало добавление мета тега в index.html:
<meta name="referrer" content="no-referrer" />


На iOS14 атрибут referrerpolicy не игнорируется.

Совместимость с различными версиями браузеров указана здесь:
https://caniuse.com/referrer-policy

### Альтернативы
Допустимо также использовать значение “origin” атрибута referrerpolicy тега img, которое отправит в referer только адрес вида “https://vk-mini-app-4859.vk.com” без параметров

### Best practice
https://web.dev/referrer-best-practices
